var wn=10,hn=10;var $star=[];var star_img_name1=["red2.png","purple2.png","green2.png","blue2.png","yellow2.png"];var star_img_name2=["red1.png","purple1.png","green1.png","blue1.png","yellow1.png"];var ST_NONE=-1,ST_RED=0,ST_PURPLE=1,ST_GREEN=2,ST_BLUE=3,ST_YELLOW=4;var starType=[];var wipeX=[],wipeY=[];var dx=[1,0,-1,0],dy=[0,1,0,-1];var visited=[];var musicNode,bgMusicNode,musicOn,score;var canOpera;var connectX=[],connectY=[];var timer;var level,score,goalScore;$(function(){for(var i=0;i<hn;++i){starType[i]=[]}var $container=$("#bg-container");for(var i=0;i<hn;++i){$star[i]=[];visited[i]=[];for(var j=0;j<wn;++j){$star[i][j]=$('<div class="star" data-x="'+i+'" data-y="'+j+'" ></div>');$star[i][j].click(function(){return selectDown(this.dataset.x,this.dataset.y)});$container.append($star[i][j]);visited[i][j]=false}}musicNode=document.getElementById("music");bgMusicNode=document.getElementById("bg-music");musicSet(true);restartGame()});function gameInit(){for(var i=0;i<hn;++i){for(var j=0;j<wn;++j){starType[i][j]=parseInt(Math.random()*999999999)%5;showStar(i,j,"normal")}}canOpera=true;timer=null;startTimer()}function restartGame(){score=0;level=1;goalScore=1000;$("#show").text("第"+level+"关").fadeIn();$("#show-msg").text("开始游戏吧！");$("#show-level").text();$("#show-goal").text("第"+level+"关  目标分:"+goalScore);$("#show-score").text("分数: "+score);setTimeout(function(){$("#show").hide();gameInit()},1000)}function nextLevel(){++level;goalScore+=(level==2?1500:2000+20*(level-3));$("#show").text("第"+level+"关").fadeIn();$("#show-goal").text("第"+level+"关  目标分:"+goalScore);setTimeout(function(){$("#show").hide();gameInit()},1000)}function gameOver(){if(score<goalScore){canOpera=false;$("#show-msg").text("在玩一次吧！");$("#show").text("游戏结束！").show()}else{nextLevel()}}function showStar(x,y,state){if(starType[x][y]!==-1){if(state==="normal"){$star[x][y].css("background-image","url(img/"+star_img_name1[starType[x][y]]+")")}else{$star[x][y].css("background-image","url(img/"+star_img_name2[starType[x][y]]+")")}}else{$star[x][y].css("background-image","none")}}function addScore(len){var s=5*len*len;$("#show-msg").text("消灭星星"+wipeX.length+"个！");$("#show-score").text("分数: "+(score+=s));$("#show-add").show().text("+"+s).fadeOut()}function showMaxlength(){clearTimeout(timer);timer=null;var times=0;(function(){if(timer==null&&canOpera){for(var i=0,len=connectX.length;i<len;++i){showStar(connectX[i],connectY[i],times%2==0?"selected":"normal")}if(++times<6){setTimeout(arguments.callee,500)}}})()}function startTimer(){if(!canOpera){return}if(connectX.length>0){for(var i=0,len=connectX.length;i<len;++i){showStar(connectX[i],connectY[i],"normal")}}if(timer!=null){clearTimeout(timer)}selectMaxConnect();timer=setTimeout(showMaxlength,3000)}function selectDown(x,y){if(!canOpera){return false}x=parseInt(x);y=parseInt(y);if(starType[x][y]!==ST_NONE){selectWipe(x,y);for(var i=0,len=wipeX.length;i<len;++i){showStar(wipeX[i],wipeY[i],"selected")}setTimeout(function(){canOpera=false;wipeStar();canOpera=true;if(IsConnect()){startTimer()}else{gameOver()}},150)}return true}function musicSet(on){if(on){bgMusicNode.play();$("#music-set").text("音乐状态：开")}else{bgMusicNode.pause();$("#music-set").text("音乐状态：关")}musicOn=on}function musicSetChange(){musicSet(!musicOn)}function IsConnect(){for(var x=0;x<hn;++x){for(var y=0;y<wn;++y){if(starType[x][y]!==-1){for(var i=0;i<2;++i){var nx=x+dx[i],ny=y+dy[i];if(nx>=0&&nx<hn&&ny>=0&&ny<wn&&!visited[nx][ny]&&starType[x][y]===starType[nx][ny]){return true}}}}}return false}function selectMaxConnect(){connectX.length=connectY.length=0;for(var x=0;x<hn;++x){for(var y=0;y<wn;++y){if(starType[x][y]!==ST_NONE&&!visited[x][y]){selectWipe(x,y);if(wipeX.length>connectX.length){connectX.length=connectY.length=0;connectX=wipeX,connectY=wipeY}wipeX=[],wipeY=[]}}}for(var x=0;x<hn;++x){for(var y=0;y<wn;++y){if(starType[x][y]!==ST_NONE&&visited[x][y]){visited[x][y]=false}}}}function wipeStar(){var len=wipeX.length;if(len>=2){for(var i=0;i<len;++i){starType[wipeX[i]][wipeY[i]]=ST_NONE;showStar(wipeX[i],wipeY[i]);visited[wipeX[i]][wipeY[i]]=false}if(musicOn){musicNode.currentTime=0;musicNode.play()}addScore(len);moveStar()}else{for(var i=0;i<len;++i){showStar(wipeX[i],wipeY[i],"normal");visited[wipeX[i]][wipeY[i]]=false}}wipeX.length=wipeY.length=0}function selectWipe(x,y){wipeX.push(x);wipeY.push(y);visited[x][y]=true;for(var i=0;i<4;++i){var nx=x+dx[i],ny=y+dy[i];if(nx>=0&&nx<hn&&ny>=0&&ny<wn&&!visited[nx][ny]&&starType[x][y]===starType[nx][ny]){selectWipe(nx,ny)}}}function moverDown(y){var x1=hn-1;for(var x2=x1;x2>=0;--x2){if(starType[x2][y]!==ST_NONE){starType[x1][y]=starType[x2][y];--x1}}for(;x1>=0;--x1){starType[x1][y]=ST_NONE}}function moveLeft(y){var y1=y;for(var y2=y1;y2<wn;++y2){if(starType[hn-1][y2]!==ST_NONE){if(y1!=y2){for(var x=0;x<hn;++x){starType[x][y1]=starType[x][y2]}}++y1}}for(;y1<wn;++y1){for(var x=0;x<wn;++x){starType[x][y1]=ST_NONE}}}function moveStar(){var isY=[],leftY=wn;for(var i=0,len=wipeY.length;i<len;++i){isY[wipeY[i]]=true;
if(wipeY[i]<leftY){leftY=wipeY[i]}}for(var y=0;y<wn;++y){if(isY[y]){moverDown(y)}}moveLeft(leftY);for(var i=0;i<hn;++i){for(var j=0;j<wn;++j){showStar(i,j,"normal")}}};